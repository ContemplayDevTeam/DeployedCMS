# Airtable Automation Setup Guide

## Overview
This guide explains how to set up the Airtable automation that sends deployed queue images to the backend API at `https://api.contemplay.ai/api/airtable/add-image`.

## Required Fields in Image Queue Table

Based on the current field inspection, you need to **add the following fields** to your "Image Queue" table in Airtable:

### Fields to Add:

1. **Image Name** (Single line text)
   - The name/title of the image
   - Example: "Person Who Can No Longer Fly"

2. **Image Info** (Long text)
   - Description of the image, artist, medium, etc.
   - Example: "This image is titled Person Who Can No Longer Fly by artist Tetsuya Ishida in 1996. The medium is acrylic on board and the work measures 40 ⅝ × 57 ⅜ inches."

3. **Home Blurb Text** (Long text)
   - Short description that appears on the homepage
   - Example: "A man is stuck inside an immobile airplane with a propeller attached to his head and his arms timidly outstretched over the rusted wings."
   - Can be empty initially (backend has defaults)

4. **Home Blurb Name** (Single line text)
   - Initials or name for the blurb attribution
   - Example: "MJ"
   - Can be empty initially (backend has defaults)

5. **Is Live** (Checkbox)
   - Whether the image is live/published
   - The automation will always send `true` for deployed queue items

6. **Info Link** (URL)
   - Optional link that opens in a new tab at the end of the experience
   - Can be empty/null

7. **Sort Order** (Number)
   - **Note:** This already exists as "Image Queue #"
   - This determines the order images appear in the experience

### Existing Fields (Already Present):
✅ Experience Type (linked record or text field)
✅ Image URL (URL or attachment field)
✅ Upload Date (used for createdAt timestamp)
✅ Image Queue # (used for sortOrder)

## Experience Type Configuration

The **Experience Type** field needs to be configured properly:

- For **HNP (Homegrown National Park)** workspace:
  - Experience Type Airtable ID: `recquHAhmVdggGNOp`
  - Experience Type Name: "nature playground"

- For **Art Playground** workspace:
  - Experience Type Airtable ID: `recgfbT7nxSsW2Y02`
  - Experience Type Name: "art playground"

### Two Options for Experience Type Field:

**Option 1: Linked Record Field (Recommended)**
- Create a separate "Experience Types" table
- Link the "Experience Type" field to this table
- This matches the reference automation pattern

**Option 2: Text Field**
- Store the Airtable record ID directly as text
- Example: Store `recquHAhmVdggGNOp` for HNP images
- The automation script handles both formats

## Automation Setup Steps

### Step 1: Add Missing Fields to Image Queue Table

Go to your "Image Queue" table in Airtable and add all the fields listed above.

### Step 2: Create the Automation

1. Go to Automations in your Airtable base
2. Click "Create automation"
3. **Trigger:** "When record created"
   - Table: "Image Queue"
4. **Action:** "Run script"
5. Copy the contents of `airtable-automation-script.js` into the script editor

### Step 3: Test the Automation

1. Add a test record to the Image Queue table with all fields populated
2. Check the automation run logs in Airtable
3. Verify the payload was sent to the backend
4. Check your backend logs to confirm the image was added

## Field Mapping Reference

The automation maps Airtable fields to the backend API payload as follows:

| Airtable Field Name | Backend Payload Key | Notes |
|---------------------|---------------------|-------|
| Record ID | `airtableId` | Auto-generated by Airtable |
| Experience Type (ID) | `experienceTypeAirtableId` | Extracted from linked record |
| Experience Type (Name) | `experienceType` | Converted to lowercase |
| Image URL | `imageUrl` | From attachment or text field |
| Image Name | `imageName` | Can be null |
| Image Info | `imageInfo` | Can be null |
| Home Blurb Text | `homeBlurbText` | Can be null (backend has defaults) |
| Home Blurb Name | `homeBlurbName` | Can be null (backend has defaults) |
| Info Link | `infoLink` | Optional URL |
| Image Queue # | `sortOrder` | Queue position number |
| Upload Date | `createdAt` | ISO timestamp |
| Current timestamp | `updatedAt` | Auto-generated |
| N/A | `contemplaytions` | Always empty array |
| N/A | `substitutions` | Always empty array |
| N/A | `isLive` | Always `true` |
| N/A | `oldAssistantId` | Always `null` |

## Payload Example

Here's what the automation sends to the backend:

```json
{
  "airtableId": "recABC123",
  "experienceTypeAirtableId": "recquHAhmVdggGNOp",
  "experienceType": "nature playground",
  "imageUrl": "https://res.cloudinary.com/...",
  "contemplaytions": [],
  "substitutions": [],
  "isLive": true,
  "imageName": "Beautiful Sunset",
  "imageInfo": "A stunning sunset over the mountains",
  "homeBlurbText": "Golden light cascades over peaks",
  "homeBlurbName": "JD",
  "oldAssistantId": null,
  "infoLink": "https://example.com/more-info",
  "sortOrder": 1,
  "createdAt": "2025-10-08T00:00:00.000Z",
  "updatedAt": "2025-10-08T20:30:00.000Z"
}
```

## Important Notes

1. **Empty Fields Are OK**: The backend handles null/empty values for optional fields like `homeBlurbText`, `homeBlurbName`, and `infoLink`

2. **Experience Type Must Be Set**: Make sure every image has an Experience Type assigned, as this is required by the backend

3. **Image Queue # for Sort Order**: The existing "Image Queue #" field is used as the `sortOrder` in the payload

4. **Always Live**: Deployed queue items are always marked as `isLive: true`

5. **Automation Triggers on Create**: The automation only runs when a NEW record is added to the Image Queue table

## Troubleshooting

- Check automation run logs in Airtable for errors
- Verify all required fields are present in the table
- Ensure Experience Type is properly formatted
- Check backend API logs for validation errors
- Make sure the Image URL is accessible

## Next Steps

After setting up the automation:

1. Test with a sample record
2. Verify the backend receives the data correctly
3. Check that the image appears in the experience
4. Monitor the automation for any failures
